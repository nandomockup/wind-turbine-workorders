name: Wind Turbine Work Orders - Auto Documentation

on:
  push:
    branches: [ main, master, develop ]
    paths:
      - '**.cs'
      - '**.csproj'
  pull_request:
    branches: [ main, master ]

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  generate-docs:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2
    
    - name: Get changed files
      id: changed-files
      run: |
        git diff --name-only HEAD^ HEAD > changed_files.txt
        echo "Changed files:"
        cat changed_files.txt
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install boto3
    
    - name: Generate documentation with AWS Bedrock
      run: |
        python3 << 'PYTHON_SCRIPT'
        import boto3
        import json
        import os
        from datetime import datetime
        
        # Initialize Bedrock client
        bedrock = boto3.client('bedrock-runtime', region_name='us-east-1')
        
        # Read changed files
        with open('changed_files.txt', 'r') as f:
            changed_files = [line.strip() for line in f if line.strip().endswith('.cs')]
        
        if not changed_files:
            print("No C# files changed, skipping documentation generation")
            exit(0)
        
        # Read content of changed files
        files_content = {}
        for file_path in changed_files:
            if os.path.exists(file_path):
                try:
                    with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
                        files_content[file_path] = f.read()
                except Exception as e:
                    print(f"Error reading {file_path}: {e}")
        
        if not files_content:
            print("No valid file content to process")
            exit(0)
        
        # Prepare enhanced prompt for Wind Turbine Work Orders system
        prompt = f"""You are analyzing a Wind Turbine Work Orders Management System built with ASP.NET Core.

Generate comprehensive, professional API documentation in Markdown format for the following changed files:

"""
        for file_path, content in files_content.items():
            # Limit to 4000 chars per file to manage token usage
            truncated_content = content[:4000]
            if len(content) > 4000:
                truncated_content += "\n... [truncated]"
            prompt += f"\n## File: {file_path}\n```csharp\n{truncated_content}\n```\n"
        
        prompt += """

Generate documentation with these sections:

# ðŸ“‹ Wind Turbine Work Orders API - Change Log

## Overview
- Summarize what changed and the business impact
- Explain how this affects work order management

## API Endpoints
For each endpoint, document:
- **HTTP Method & Route**
- **Purpose** - What does this endpoint do in the work order workflow?
- **Parameters** - Query params, route params, request body
- **Request Example** - JSON payload
- **Response Example** - Success response with JSON
- **Error Responses** - Common errors (400, 401, 404, 500)
- **Authorization** - Required roles or permissions

## Data Models
- Document any DTOs, entities, or view models
- Show property types and validation rules
- Explain relationships (e.g., WorkOrder â†’ Turbine)

## Business Logic
- Key business rules implemented
- Workflows (e.g., work order lifecycle: Created â†’ Assigned â†’ In Progress â†’ Completed)
- Validation logic

## Database Changes
- Any new tables, columns, or migrations
- Relationships and foreign keys

## Integration Points
- External APIs or services used
- Message queues or event handlers

## Usage Examples
Provide code snippets showing:
- How to create a work order
- How to update turbine status
- How to query work orders by date/technician

## Testing Notes
- Suggest test cases for QA
- Edge cases to validate

---
**Format:** Use proper Markdown with headers, code blocks, tables, and emojis for better readability.
**Style:** Professional, clear, and developer-friendly.
"""

        # Call Bedrock with Claude
        request_body = {
            "anthropic_version": "bedrock-2023-05-31",
            "max_tokens": 4096,
            "temperature": 0.3,
            "messages": [
                {
                    "role": "user",
                    "content": prompt
                }
            ]
        }
        
        try:
            response = bedrock.invoke_model(
                modelId='anthropic.claude-3-5-sonnet-20241022-v2:0',
                body=json.dumps(request_body)
            )
            
            response_body = json.loads(response['body'].read())
            documentation = response_body['content'][0]['text']
            
            # Create docs directory
            os.makedirs('docs', exist_ok=True)
            
            # Check if index exists and append, or create new
            timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S UTC')
            date_only = datetime.now().strftime('%Y-%m-%d')
            
            # Generate changelog entry
            changelog_entry = f"""
---

## Update: {timestamp}

**Changed Files:**
{chr(10).join(f'- `{f}`' for f in changed_files)}

{documentation}

"""
            
            # Update or create index
            index_path = 'docs/index.md'
            if os.path.exists(index_path):
                with open(index_path, 'r', encoding='utf-8') as f:
                    existing_content = f.read()
                
                # Insert new changelog at the top (after header)
                if '# ðŸŒ¬ï¸ Wind Turbine Work Orders API Documentation' in existing_content:
                    parts = existing_content.split('---', 1)
                    new_content = parts[0] + changelog_entry + (parts[1] if len(parts) > 1 else '')
                else:
                    new_content = f"""# ðŸŒ¬ï¸ Wind Turbine Work Orders API Documentation

**Last Updated:** {timestamp}

{changelog_entry}

{existing_content}
"""
            else:
                new_content = f"""# ðŸŒ¬ï¸ Wind Turbine Work Orders API Documentation

**Repository:** [wind-turbine-workorders](https://github.com/nandomockup/wind-turbine-workorders)  
**Last Updated:** {timestamp}

> ðŸ¤– This documentation is automatically generated using AI whenever the API code changes.

{changelog_entry}

---

## ðŸ“š Quick Links
- [API Reference](#api-endpoints)
- [Data Models](#data-models)
- [Setup Guide](./setup.md)
- [Changelog](./changelog.md)

"""
            
            with open(index_path, 'w', encoding='utf-8') as f:
                f.write(new_content)
            
            # Also create a separate changelog file
            changelog_path = 'docs/changelog.md'
            if os.path.exists(changelog_path):
                with open(changelog_path, 'r', encoding='utf-8') as f:
                    changelog_content = f.read()
                changelog_content = f"# ðŸ“ Changelog\n\n{changelog_entry}\n\n{changelog_content}"
            else:
                changelog_content = f"# ðŸ“ Changelog\n\n{changelog_entry}"
            
            with open(changelog_path, 'w', encoding='utf-8') as f:
                f.write(changelog_content)
            
            print(f"âœ… Documentation generated successfully!")
            print(f"ðŸ“„ Updated: docs/index.md")
            print(f"ðŸ“ Updated: docs/changelog.md")
            
        except Exception as e:
            print(f"âŒ Error calling Bedrock: {e}")
            raise
        
        PYTHON_SCRIPT
    
    - name: Setup GitHub Pages config
      run: |
        cd docs
        cat > _config.yml << 'EOF'
        theme: jekyll-theme-slate
        title: Wind Turbine Work Orders API
        description: Auto-generated API documentation for Wind Turbine Work Order Management System
        show_downloads: true
        EOF
    
    - name: Create README for docs
      run: |
        cd docs
        if [ ! -f README.md ]; then
          cat > README.md << 'EOF'
        # Wind Turbine Work Orders API Documentation
        
        This documentation is automatically generated from the codebase.
        
        ## Quick Start
        - [API Documentation](./index.md)
        - [Changelog](./changelog.md)
        
        EOF
        fi
    
    - name: Commit documentation
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add docs/
        git diff --staged --quiet || git commit -m "ðŸ“š Auto-generated API documentation [skip ci]"
    
    - name: Push changes
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref }}
    
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs
        publish_branch: gh-pages

  deploy-to-aws-vm:
    needs: generate-docs
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'  # Adjust to your .NET version
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Build
      run: dotnet build --configuration Release --no-restore
    
    - name: Publish
      run: dotnet publish --configuration Release --no-build --output ./publish
    
    - name: Deploy to AWS VM
      env:
        SSH_PRIVATE_KEY: ${{ secrets.AWS_VM_SSH_KEY }}
        VM_HOST: ${{ secrets.AWS_VM_HOST }}
        VM_USER: ${{ secrets.AWS_VM_USER }}
      run: |
        # Setup SSH
        mkdir -p ~/.ssh
        echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        
        # Add VM to known hosts
        ssh-keyscan -H $VM_HOST >> ~/.ssh/known_hosts
        
        # Copy files to VM
        scp -i ~/.ssh/deploy_key -r ./publish/* $VM_USER@$VM_HOST:/var/www/wind-turbine-workorders/
        
        # Restart the application (adjust command as needed)
        ssh -i ~/.ssh/deploy_key $VM_USER@$VM_HOST << 'ENDSSH'
          cd /var/www/wind-turbine-workorders
          sudo systemctl restart wind-turbine-api
        ENDSSH
        
        echo "âœ… Deployed to AWS VM successfully!"
