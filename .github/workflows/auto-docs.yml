name: Wind Turbine Work Orders - Auto Documentation

on:
  push:
    branches: [ main, master, develop ]
    paths:
      - '**.cs'
      - '**.csproj'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  generate-docs:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2
    
    - name: Get changed files
      id: changed-files
      run: |
        git diff --name-only HEAD^ HEAD > changed_files.txt
        echo "Changed files:"
        cat changed_files.txt
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install boto3 markdown2
    
    - name: Create HTML template
      run: |
        mkdir -p .templates
        cat > .templates/doc_template.html << 'TEMPLATE'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Wind Turbine Work Orders - API Documentation</title>
            <style>
                * { margin: 0; padding: 0; box-sizing: border-box; }
                body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; line-height: 1.6; color: #333; background: #f5f5f5; }
                .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                .container { max-width: 1200px; margin: 0 auto; padding: 0 2rem; }
                .header h1 { font-size: 2.5rem; margin-bottom: 0.5rem; }
                .header p { opacity: 0.9; font-size: 1.1rem; }
                .meta { background: white; margin: 2rem auto; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
                .meta-item { display: inline-block; margin-right: 2rem; margin-bottom: 0.5rem; }
                .meta-label { font-weight: 600; color: #667eea; }
                .content { background: white; margin: 0 auto 2rem; padding: 2.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
                .content h2 { color: #667eea; margin-top: 2rem; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #e0e0e0; }
                .content h3 { color: #764ba2; margin-top: 1.5rem; margin-bottom: 0.75rem; }
                .content h4 { color: #555; margin-top: 1rem; margin-bottom: 0.5rem; }
                .content ul, .content ol { margin-left: 2rem; margin-bottom: 1rem; }
                .content li { margin-bottom: 0.5rem; }
                .content code { background: #f4f4f4; padding: 0.2rem 0.4rem; border-radius: 3px; font-family: Monaco, monospace; font-size: 0.9em; color: #e83e8c; }
                .content pre { background: #2d2d2d; color: #f8f8f2; padding: 1.5rem; border-radius: 6px; overflow-x: auto; margin: 1rem 0; }
                .content pre code { background: none; color: inherit; padding: 0; }
                .content table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
                .content table th { background: #667eea; color: white; padding: 0.75rem; text-align: left; }
                .content table td { padding: 0.75rem; border-bottom: 1px solid #e0e0e0; }
                .content table tr:hover { background: #f9f9f9; }
                .footer { text-align: center; padding: 2rem; color: #666; font-size: 0.9rem; }
            </style>
        </head>
        <body>
            <div class="header">
                <div class="container">
                    <h1>üå¨Ô∏è Wind Turbine Work Orders</h1>
                    <p>API Documentation - Auto-Generated</p>
                </div>
            </div>
            <div class="container">
                <div class="meta">
                    <div class="meta-item"><span class="meta-label">Last Updated:</span> {{TIMESTAMP}}</div>
                    <div class="meta-item"><span class="meta-label">Repository:</span> <a href="https://github.com/nandomockup/wind-turbine-workorders">wind-turbine-workorders</a></div>
                    <div class="meta-item"><span class="meta-label">Changed Files:</span> {{FILE_COUNT}}</div>
                </div>
                <div class="content">
                    <h2>üìù Latest Changes</h2>
                    <p><strong>Files modified in this update:</strong></p>
                    <ul>{{CHANGED_FILES}}</ul>
                    <hr style="margin: 2rem 0; border: none; border-top: 1px solid #e0e0e0;">
                    {{CONTENT}}
                </div>
            </div>
            <div class="footer">
                <p>Documentation automatically generated using AWS Bedrock (Claude AI)</p>
                <p>Wind Turbine Work Orders Management System ¬© 2025</p>
            </div>
        </body>
        </html>
        TEMPLATE
    
    - name: Generate documentation with AWS Bedrock
      run: |
        python3 << 'EOF'
        import boto3
        import json
        import os
        from datetime import datetime
        import markdown2
        
        bedrock = boto3.client('bedrock-runtime', region_name='us-east-1')
        
        with open('changed_files.txt', 'r') as f:
            changed_files = [line.strip() for line in f if line.strip().endswith('.cs')]
        
        if not changed_files:
            print("No C# files changed")
            exit(0)
        
        files_content = {}
        for file_path in changed_files:
            if os.path.exists(file_path):
                try:
                    with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
                        files_content[file_path] = f.read()[:4000]
                except Exception as e:
                    print(f"Error reading {file_path}: {e}")
        
        if not files_content:
            exit(0)
        
        prompt_parts = ["Analyze this Wind Turbine Work Orders API code and generate professional documentation.", ""]
        
        for file_path, content in files_content.items():
            prompt_parts.append(f"File: {file_path}")
            prompt_parts.append(f"```csharp\n{content}\n```")
        
        prompt_parts.extend([
            "",
            "Create documentation with:",
            "- Overview of changes and business impact",
            "- API endpoints with methods, routes, parameters, examples",
            "- Data models and relationships", 
            "- Business logic and workflows",
            "- Usage examples",
            "",
            "Use Markdown format, professional tone for management."
        ])
        
        try:
            response = bedrock.invoke_model(
                modelId='us.anthropic.claude-3-5-sonnet-20241022-v2:0',
                body=json.dumps({
                    "anthropic_version": "bedrock-2023-05-31",
                    "max_tokens": 4096,
                    "temperature": 0.3,
                    "messages": [{"role": "user", "content": "\n".join(prompt_parts)}]
                })
            )
            
            markdown_content = json.loads(response['body'].read())['content'][0]['text']
            html_body = markdown2.markdown(markdown_content, extras=["fenced-code-blocks", "tables"])
            
            os.makedirs('docs', exist_ok=True)
            
            with open('.templates/doc_template.html', 'r') as f:
                html_template = f.read()
            
            timestamp = datetime.now().strftime('%B %d, %Y at %H:%M UTC')
            changed_files_html = ''.join(f'<li><code>{f}</code></li>' for f in changed_files)
            
            final_html = html_template.replace('{{TIMESTAMP}}', timestamp)
            final_html = final_html.replace('{{FILE_COUNT}}', str(len(changed_files)))
            final_html = final_html.replace('{{CHANGED_FILES}}', changed_files_html)
            final_html = final_html.replace('{{CONTENT}}', html_body)
            
            with open('docs/index.html', 'w', encoding='utf-8') as f:
                f.write(final_html)
            
            print("‚úÖ Documentation generated!")
            
        except Exception as e:
            print(f"‚ùå Error: {e}")
            raise
        
        EOF
    
    - name: Commit documentation
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add docs/
        git diff --staged --quiet || git commit -m "üìö Auto-generated API documentation [skip ci]"
    
    - name: Push changes
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref }}
    
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs
        publish_branch: gh-pages
        enable_jekyll: false
